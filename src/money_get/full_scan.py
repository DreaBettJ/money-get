"""å…¨å¸‚åœºæ‰«æç³»ç»Ÿ - é›†æˆåˆ°money-get"""
import logging
from money_get.scraper import get_stock_price
from concurrent.futures import ThreadPoolExecutor, as_completed
import time
from datetime import datetime

# ç›´æ¥åˆ›å»ºloggerï¼Œé¿å…å¤šçº¿ç¨‹é—®é¢˜
_logger = logging.getLogger('money_get.full_scan')
if not _logger.handlers:
    _logger.setLevel(logging.INFO)
    handler = logging.StreamHandler()
    handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
    _logger.addHandler(handler)

# Aè‚¡æ ¸å¿ƒè‚¡ç¥¨æ± ï¼ˆ500åªï¼‰
STOCK_POOL = [
    # æ²ªæ·±300
    '600519', '000858', '600036', '601318', '600900', '600276', '601166', '601398',
    '600028', '601988', '601857', '600050', '601288', '600016', '601088', '600030',
    '601012', '600585', '600690', '600309', '600887', '600018', '600009', '601328',
    '600000', '601229', '601319', '601688', '600837', '600104', '600606', '601668',
    '600745', '600031', '600348', '600547', '601866', '601618', '601390', '601336',
    '601899', '600518', '600867', '601877', '600507', '600170', '600487', '600588',
    '600850', '600703', '600809', '600660', '601601', '600612', '600760', '600645',
    '600522', '600176', '600496', '600183', '600261', '600409', '600059', '600733',
    '600316', '600811', '600795', '600100', '600570', '600816', '600031', '600745',
    '601169', '600048', '600011', '600028', '600688', '600867', '601225', '600919',
    '600398', '600176', '600036', '600030', '600048', '600000', '600015', '600016',
    '600018', '600019', '600020', '600021', '600022', '600023', '600025', '600026',
    '600027', '600028', '600029', '600030', '600031', '600032', '600033', '600035',
    '600036', '600037', '600038', '600039', '600040', '600041', '600042', '600043',
    '600045', '600048', '600050', '600051', '600052', '600053', '600054', '600055',
    '600056', '600057', '600058', '600059', '600060', '600061', '600062', '600063',
    '600064', '600066', '600067', '600068', '600069', '600070', '600071', '600072',
    '600073', '600075', '600076', '600077', '600078', '600079', '600080', '600081',
    '600082', '600083', '600084', '600085', '600086', '600087', '600088', '600089',
    '600090', '600091', '600092', '600093', '600094', '600095', '600096', '600097',
    '600098', '600099', '600100', '600101', '600102', '600103', '600104', '600105',
    '600106', '600107', '600108', '600109', '600110', '600111', '600112', '600113',
    '600114', '600115', '600116', '600117', '600118', '600119', '600120', '600121',
    '600122', '600123', '600124', '600125', '600126', '600127', '600128', '600129',
    '600130', '600131', '600132', '600133', '600135', '600136', '600137', '600138',
    '600139', '600140', '600141', '600142', '600143', '600144', '600145', '600146',
    '600147', '600148', '600149', '600150', '600151', '600152', '600153', '600154',
    '600155', '600156', '600157', '600158', '600159', '600160', '600161', '600162',
    # çƒ­é—¨æ¦‚å¿µ-æ–°èƒ½æº
    '300750', '300014', '002594', '002466', '002475', '002371', '300012', '300124',
    '300014', '002594', '300750', '300751', '300763', '002466', '002475', '300014',
    '300750', '002594', '002371', '300124', '300014', '002594', '002466', '300750',
    # çƒ­é—¨æ¦‚å¿µ-ç§‘æŠ€
    '300059', '300122', '300166', '300182', '300212', '300223', '300251', '300274',
    '300308', '300347', '300408', '300433', '300459', '300496', '300527', '300581',
    '300598', '300618', '300663', '300672', '300696', '300719', '300770', '300782',
    '300896', '300033', '300002', '300003', '300004', '300006', '300007', '300008',
    '300009', '300010', '300015', '300016', '300017', '300018', '300019', '300020',
    '300021', '300022', '300023', '300024', '300025', '300026', '300027', '300028',
    '300029', '300030', '300031', '300032', '300033', '300034', '300035', '300036',
    '300037', '300038', '300039', '300040', '300041', '300042', '300043', '300044',
    '300045', '300046', '300047', '300048', '300049', '300050', '300051', '300052',
    '300053', '300054', '300055', '300056', '300057', '300058', '300059', '300060',
    '300061', '300062', '300063', '300064', '300065', '300066', '300067', '300068',
    '300069', '300070', '300071', '300072', '300073', '300074', '300075', '300076',
    '300077', '300078', '300079', '300080', '300081', '300082', '300083', '300084',
    '300085', '300086', '300087', '300088', '300089', '300090', '300091', '300092',
    '300093', '300094', '300095', '300096', '300097', '300098', '300099', '300100',
    '300101', '300102', '300103', '300104', '300105', '300106', '300107', '300108',
    '300109', '300110', '300111', '300112', '300113', '300114', '300115', '300116',
    '300117', '300118', '300119', '300120', '300121', '300122', '300123', '300124',
    '300125', '300126', '300127', '300128', '300129', '300130', '300131', '300132',
    '300133', '300134', '300135', '300136', '300137', '300138', '300139', '300140',
    '300141', '300142', '300143', '300144', '300145', '300146', '300147', '300148',
    '300149', '300150', '300151', '300152', '300153', '300154', '300155', '300156',
    '300157', '300158', '300159', '300160', '300161', '300162', '300163', '300164',
    '300165', '300166', '300167', '300168', '300169', '300170', '300171', '300172',
    '300173', '300174', '300175', '300176', '300177', '300178', '300179', '300180',
    '300181', '300182', '300183', '300184', '300185', '300186', '300187', '300188',
    '300189', '300190', '300191', '300192', '300193', '300194', '300195', '300196',
    '300197', '300198', '300199', '300200', '300201', '300202', '300203', '300204',
    '300205', '300206', '300207', '300208', '300209', '300210', '300211', '300212',
]


def scan_stock(code: str) -> dict:
    """æ‰«æå•åªè‚¡ç¥¨"""
    try:
        p = get_stock_price(code)
        if p:
            return {
                'code': code,
                'name': p.get('name', ''),
                'price': p.get('price', 0),
                'change': (p.get('pct', 0) or 0) * 100,
                'volume': p.get('volume', 0),
                'amount': p.get('amount', 0),
            }
    except Exception as e:
        _logger.warning(f"æ‰«æå¤±è´¥ {code}: {e}")
    return None


def full_scan(stock_count: int = 500, workers: int = 20) -> list:
    """å…¨å¸‚åœºæ‰«æ
    
    Args:
        stock_count: æ‰«æè‚¡ç¥¨æ•°é‡
        workers: å¹¶å‘æ•°
        
    Returns:
        list: æ’åºåçš„ç»“æœ
    """
    _logger.info(f"ğŸš€ å¼€å§‹å…¨å¸‚åœºæ‰«æ (ç›®æ ‡: {stock_count}åª)")
    start_time = time.time()
    
    # å»é‡
    stocks = list(set(STOCK_POOL))[:stock_count]
    _logger.info(f"ğŸ“‹ è‚¡ç¥¨æ± : {len(stocks)}åª")
    
    results = []
    fail_count = 0
    
    # å¹¶å‘æ‰«æ
    with ThreadPoolExecutor(max_workers=workers) as executor:
        futures = {executor.submit(scan_stock, c): c for c in stocks}
        completed = 0
        
        for future in as_completed(futures):
            completed += 1
            result = future.result()
            
            if result:
                results.append(result)
            else:
                fail_count += 1
            
            # æ¯50åªè¾“å‡ºè¿›åº¦
            if completed % 50 == 0:
                _logger.info(f"â³ è¿›åº¦: {completed}/{len(stocks)} (æˆåŠŸ: {len(results)}, å¤±è´¥: {fail_count})")
    
    elapsed = time.time() - start_time
    
    # æ’åº
    results.sort(key=lambda x: x['change'], reverse=True)
    
    _logger.info(f"âœ… æ‰«æå®Œæˆ: {len(results)}åªæˆåŠŸ, {fail_count}åªå¤±è´¥, è€—æ—¶ {elapsed:.1f}ç§’")
    
    return results


def get_top_stocks(results: list, n: int = 10) -> list:
    """è·å–Top Nè‚¡ç¥¨"""
    return results[:n]


def get_bottom_stocks(results: list, n: int = 10) -> list:
    """è·å–è·Œå¹…å‰Nè‚¡ç¥¨"""
    return results[-n:] if len(results) >= n else results


def format_report(results: list, top_n: int = 20) -> str:
    """ç”ŸæˆæŠ¥å‘Š"""
    lines = []
    lines.append(f"\n{'='*70}")
    lines.append(f"ğŸ“Š å…¨å¸‚åœºæ‰«ææŠ¥å‘Š - {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    lines.append(f"{'='*70}")
    lines.append(f"æ‰«æè‚¡ç¥¨: {len(results)}åª")
    lines.append(f"\n{'æ’å':<4} {'ä»£ç ':<8} {'åç§°':<12} {'ä»·æ ¼':<10} {'æ¶¨å¹…'}")
    lines.append("-" * 55)
    
    for i, r in enumerate(results[:top_n], 1):
        lines.append(f"{i:<4} {r['code']:<8} {r['name']:<12} {r['price']:<10.2f} {r['change']:+.2f}%")
    
    # Top 5
    lines.append(f"\nğŸ”¥ æ¶¨å¹…å‰5:")
    for r in results[:5]:
        lines.append(f"  {r['code']} {r['name']}: {r['change']:+.2f}%")
    
    # Down 5
    lines.append(f"\nğŸ“‰ è·Œå¹…å‰5:")
    for r in results[-5:]:
        lines.append(f"  {r['code']} {r['name']}: {r['change']:+.2f}%")
    
    return "\n".join(lines)


def run_full_scan(count: int = 500):
    """è¿è¡Œå…¨å¸‚åœºæ‰«æ"""
    _logger.info(f"="*50)
    _logger.info(f"å¼€å§‹å…¨å¸‚åœºæ‰«æ: {count}åªè‚¡ç¥¨")
    _logger.info(f"="*50)
    
    results = full_scan(count)
    
    # è¾“å‡ºæŠ¥å‘Š
    report = format_report(results)
    print(report)
    
    # è®°å½•æ—¥å¿—
    top5 = [(r['code'], r['name'], f"{r['change']:+.2f}%") for r in results[:5]]
    down5 = [(r['code'], r['name'], f"{r['change']:+.2f}%") for r in results[-5:]]
    _logger.info(f"æ¶¨å¹…å‰5: {top5}")
    _logger.info(f"è·Œå¹…å‰5: {down5}")
    
    return results


if __name__ == "__main__":
    run_full_scan(500)
